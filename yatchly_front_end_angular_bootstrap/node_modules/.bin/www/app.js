var express = require('express');
var app = express();
var dust = require('express-dustjs')
var path = require('path')
var request = require('request');

app.use(express.static(path.join(__dirname, 'public')));

// Dustjs settings
dust._.optimizers.format = function (ctx, node) {
  return node
}
 
// Define custom Dustjs helper
dust._.helpers.demo = function (chk, ctx, bodies, params) {
  return chk.w('demo')
}
 
// Use Dustjs as Express view engine
app.engine('dust', dust.engine({
  // Use dustjs-helpers
  useHelpers: true
}))
app.set('view engine', 'dust')
app.set('views', path.resolve(__dirname, './views'))
 
app.get('/', function (req, res) {
  res.render('index', {
    render: 'user/index'
  })
})

app.get('/user/add', function (req, res) {
  res.render('partials/user/form', {

  })
})

app.get('/user', function (req, res) {
  res.render('partials/user/index', {

  })
})

app.get('/user/edit/:userID', function (req, res) {
	var userID = req.params.userID;
	console.log(userID);
	
	request({
    url: 'http://127.0.0.1:3000/api/user/get',
    method: "POST",
    json: true,   // <--Very important!!!
    body: {userID: userID}
	}, function (error, response, body){
		var user = response.body.data;
		console.log(user);
		res.render('partials/user/form', {user : user});
	});
	/*
	request.post('http://127.0.0.1:8000/api/user/get',{ json: { userID: userID } },
		function (error, response, body) {
				console.log(response)
		}
	);
	
	app.post('http://127.0.0.1:3000/api/user/get', function (req, res) {
		var ret = 'userID:' + userID;
		console.log(ret);

	})
			*/
	  	

})

app.listen(8000);